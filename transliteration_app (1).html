
<!DOCTYPE html>
<html>
<head>
    <title>Transliteration App</title>
    <script src="https://cdn.jsdelivr.net/npm/anvil-uplink@0.6.0/dist/anvil-uplink.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }
        textarea {
            width: 80%;
            height: 100px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 5px; /* Add some spacing between buttons */
        }
        #output {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 100px;
            white-space: pre-wrap; /* To preserve line breaks */
        }
        .language-options {
            margin-bottom: 10px;
        }
        .language-options input[type="radio"] {
            margin-right: 5px;
        }
        .language-options label {
            margin-right: 15px;
        }
        #savedTextsList {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .saved-item {
            margin-bottom: 5px;
            padding: 8px; /* Increased padding */
            border-bottom: 1px dashed #eee;
            word-break: break-word; /* Break long words */
            background-color: #f9f9f9; /* Light background */
            border-radius: 4px; /* Rounded corners */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically center items */
        }
        .saved-item:hover {
             background-color: #e9e9e9; /* Hover effect */
        }
        .saved-item.selected {
             background-color: #d0e0f0; /* Highlight selected items */
        }
        .saved-item input[type="checkbox"] {
            margin-right: 10px;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
         .saved-item .text-snippet {
             flex-grow: 1; /* Allow text snippet to take available space */
             white-space: nowrap; /* Prevent wrapping for snippet */
             overflow: hidden; /* Hide overflow text */
             text-overflow: ellipsis; /* Add ellipsis for truncated text */
         }
         .saved-item .timestamp {
             font-size: 0.8em;
             color: #666;
             margin-left: 10px;
             flex-shrink: 0; /* Prevent timestamp from shrinking */
         }
        .loading-indicator {
            font-style: italic;
            color: #888;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Transliteration</h1>

    <div class="language-options">
        <input type="radio" id="arabic" name="language" value="arabic" checked>
        <label for="arabic">Arabic</label>
        <input type="radio" id="tamil_literal" name="language" value="tamil_literal">
        <label for="tamil_literal">Tamil (Literal)</label>
        <input type="radio" id="tamil_syllabic" name="language" value="tamil_syllabic">
        <label for="tamil_syllabic">Tamil (Syllabic)</label>
    </div>

    <textarea id="inputText" placeholder="Enter text in Portuguese"></textarea><br>
    <button id="transliterateBtn" onclick="transliterate()">Transliterate</button>

    <h2>Output</h2>
    <div id="output"></div>

    <button id="saveBtn" onclick="saveTransliteration()">Save Transliteration</button>
    <button id="deleteBtn" onclick="deleteSelected()">Delete Selected</button>
    <button id="downloadBtn" onclick="downloadPdf()">Download as PDF</button>

    <h2>Saved Texts</h2>
    <div id="savedTextsList">
        <!-- Saved texts will be displayed here -->
        <div class="loading-indicator">Loading saved texts...</div>
    </div>


    <script>
        // Initialize Anvil Uplink (replace 'YOUR_ANVIL_APP_ID' with your Anvil App ID)
        // You can find your App ID in your Anvil app's URL or App Settings.
        // Note: Replace 'YOUR_ANVIL_APP_ID' with your actual Anvil App ID.
        anvil.connect("YOUR_ANVIL_APP_ID");

        // Helper function to set button state
        function setButtonState(disabled) {
            document.getElementById('transliterateBtn').disabled = disabled;
            document.getElementById('saveBtn').disabled = disabled;
            document.getElementById('deleteBtn').disabled = disabled;
            document.getElementById('downloadBtn').disabled = disabled;
        }

        async function transliterate() {
            const inputText = document.getElementById('inputText').value;
            const outputDiv = document.getElementById('output');
            outputDiv.innerText = "Transliterating...";
            setButtonState(true); // Disable buttons during transliteration

            // Get selected language
            const selectedLanguage = document.querySelector('input[name="language"]:checked').value;

            try {
                let translatedText = "";
                if (selectedLanguage === "arabic") {
                    translatedText = await anvil.server.call('transliterate_arabic', inputText);
                } else if (selectedLanguage === "tamil_literal") {
                    translatedText = await anvil.server.call('transliterate_tamil_literal', inputText);
                } else if (selectedLanguage === "tamil_syllabic") {
                    translatedText = await anvil.server.call('transliterate_tamil_silabico', inputText);
                }

                // Use arabic-reshaper and python-bidi for Arabic text if needed
                // Note: Anvil backend might handle this, depending on implementation
                 if (selectedLanguage === "arabic") {
                     // Simple display, rendering might need more advanced JS or Anvil backend handling
                     outputDiv.innerText = translatedText;
                 } else {
                    outputDiv.innerText = translatedText;
                 }


            } catch (error) {
                outputDiv.innerText = "Error during transliteration: " + error.message;
                console.error("Anvil transliteration call failed:", error);
                alert("Transliteration failed: " + error.message); // More specific error
            } finally {
                setButtonState(false); // Re-enable buttons
            }
        }

        async function saveTransliteration() {
             const textToSave = document.getElementById('output').innerText;
             if (textToSave && textToSave !== "Transliterating..." && !textToSave.startsWith("Error:")) {
                 setButtonState(true); // Disable buttons during save
                 const saveBtn = document.getElementById('saveBtn');
                 const originalSaveBtnText = saveBtn.innerText;
                 saveBtn.innerText = "Saving..."; // Visual feedback

                try {
                    // Call Anvil function 'save_text'
                    // Assuming Anvil backend adds a timestamp when saving
                    const savedTextId = await anvil.server.call('save_text', textToSave);
                    console.log('Text saved with ID:', savedTextId);
                    alert('Text saved successfully.'); // More specific success message
                    loadSavedTexts(); // Reload the list after saving
                } catch (error) {
                    alert("Failed to save text: " + error.message); // More specific error
                    console.error("Anvil save failed:", error);
                } finally {
                    saveBtn.innerText = originalSaveBtnText; // Restore button text
                    setButtonState(false); // Re-enable buttons
                }
            } else {
                alert("No valid text in the output area to save."); // More specific message
            }
        }

        async function deleteSelected() {
             const selectedItems = document.querySelectorAll('#savedTextsList input[type="checkbox"]:checked');
            const idsToDelete = Array.from(selectedItems).map(checkbox => checkbox.dataset.id);

            if (idsToDelete.length > 0) {
                 setButtonState(true); // Disable buttons during delete
                 const deleteBtn = document.getElementById('deleteBtn');
                 const originalDeleteBtnText = deleteBtn.innerText;
                 deleteBtn.innerText = "Deleting..."; // Visual feedback

                try {
                    // Call Anvil function 'delete_texts'
                    await anvil.server.call('delete_texts', idsToDelete);
                    console.log('Selected texts deleted:', idsToDelete);
                    alert(`Successfully deleted ${idsToDelete.length} selected texts.`); // More specific success message
                    loadSavedTexts(); // Reload the list after deleting
                } catch (error) {
                    alert("Failed to delete texts: " + error.message); // More specific error
                    console.error("Anvil delete failed:", error);
                } finally {
                    deleteBtn.innerText = originalDeleteBtnText; // Restore button text
                    setButtonState(false); // Re-enable buttons
                }
            } else {
                alert("No texts selected for deletion."); // More specific message
            }
        }

        async function downloadPdf() {
             const selectedItems = document.querySelectorAll('#savedTextsList input[type="checkbox"]:checked');
            const idsToDownload = Array.from(selectedItems).map(checkbox => checkbox.dataset.id);

            if (idsToDownload.length > 0) {
                 setButtonState(true); // Disable buttons during download
                 const downloadBtn = document.getElementById('downloadBtn');
                 const originalDownloadBtnText = downloadBtn.innerText;
                 downloadBtn.innerText = "Generating PDF..."; // Visual feedback

                try {
                    // Call Anvil function 'generate_pdf_from_texts'
                    const pdfBlob = await anvil.server.call('generate_pdf_from_texts', idsToDownload);

                    // Create a blob URL and trigger download
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'transliterations.pdf';
                    document.body.appendChild(a);
                    a.click();

                    // Clean up
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log(`Generated PDF for ${idsToDownload.length} texts.`);
                    alert(`PDF generated successfully for ${idsTopload.length} texts.`); // More specific success message

                } catch (error) {
                    alert("Failed to generate PDF: " + error.message); // More specific error
                    console.error("Anvil PDF generation failed:", error);
                } finally {
                    downloadBtn.innerText = originalDownloadBtnText; // Restore button text
                    setButtonState(false); // Re-enable buttons
                }
            } else {
                 alert("No texts selected for PDF download."); // More specific message
            }
        }

         async function loadSavedTexts() {
            const savedTextsListDiv = document.getElementById('savedTextsList');
            savedTextsListDiv.innerHTML = '<div class="loading-indicator">Loading saved texts...</div>'; // Loading indicator

            try {
                // Call Anvil function 'get_saved_texts'
                // Assuming Anvil backend returns a list of objects with 'id', 'text', and 'timestamp'
                const savedTexts = await anvil.server.call('get_saved_texts');

                savedTextsListDiv.innerHTML = ''; // Clear loading indicator

                if (savedTexts.length === 0) {
                    savedTextsListDiv.innerText = 'No saved texts yet.';
                } else {
                    savedTexts.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('saved-item');
                         // Add click listener to select the item
                        itemDiv.addEventListener('click', function() {
                            const checkbox = this.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            this.classList.toggle('selected', checkbox.checked);
                        });


                        // Display checkbox with data-id, a snippet of the text, and timestamp
                        // Truncate text to 150 characters and add ellipsis
                        const textSnippet = item.text.length > 150 ? item.text.substring(0, 150) + '...' : item.text;
                        const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'No timestamp'; // Format timestamp

                        itemDiv.innerHTML = `
                            <input type="checkbox" data-id="${item.id}">
                            <span class="text-snippet">${textSnippet}</span>
                            <span class="timestamp">${timestamp}</span>
                        `;
                        savedTextsListDiv.appendChild(itemDiv);

                         // Add event listener to checkbox for selection class
                         itemDiv.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                            itemDiv.classList.toggle('selected', this.checked);
                        });

                    });
                }
            } catch (error) {
                savedTextsListDiv.innerHTML = ''; // Clear loading indicator
                savedTextsListDiv.innerText = "Error loading saved texts: " + error.message; // More specific error
                console.error("Anvil load saved texts failed:", error);
                alert("Failed to load saved texts: " + error.message); // Alert user
            }
        }

        // Load saved texts when the page loads
        window.onload = loadSavedTexts;


    </script>
</body>
</html>
